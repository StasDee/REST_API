name: CI Tests (Kubernetes)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  k8s-tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: v1.29.0

      - name: Set up kind
        uses: helm/kind-action@v1.10.0
        with:
          version: v0.31.0

      - name: Verify tools
        run: |
          docker --version
          kubectl version --client
          kind --version

      - name: Create ConfigMap from secrets
        run: |
          echo "BASE_URL=${{ secrets.BASE_URL }}" > .env
          echo "API_TOKEN=${{ secrets.API_TOKEN }}" >> .env

      - name: Run Kubernetes tests
        run: bash ci/run_k8s_tests.sh

